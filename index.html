<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Immunization Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f9fafb; }
    h1 { text-align: center; }
    .chart-container { width: 500px; margin: 30px auto; }
    table { margin-top: 40px; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Immunization Dashboard</h1>

  <div class="chart-container">
    <canvas id="genderChart"></canvas>
  </div>

  <table id="recordsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Last Name</th>
        <th>First Name</th>
        <th>Middle</th>
        <th>Mother</th>
        <th>Birthday</th>
        <th>Gender</th>
        <th>Address</th>
        <th>Municipality</th>
        <th>BCG</th>
        <th>HepB</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchSheetData() {
      // Use CSV link from Publish to web â†’ CSV
      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8qr3RNfzQobIMSn-9LMvbf4gVL-HxT0yzqp6ced96IWzRucs0rEfduPJr7YIuv3gBs5073ZQBrzTl/pub?output=csv";
      const resp = await fetch(csvUrl);
      const text = await resp.text();
      
      // Parse CSV
      const lines = text.split("\n").map(l => l.split(","));
      const headers = lines.shift(); // remove header row

      return lines
        .filter(r => r.length > 1) // skip empty rows
        .map(r => ({
          last: r[0] || "",
          name: r[1] || "",
          middle: r[2] || "",
          mother: r[3] || "",
          birthday: r[4] || "",
          gender: r[5] || "",
          address: r[6] || "",
          municipality: r[7] || "",
          bcg: r[8] || "",
          hepb: r[9] || ""
        }));
    }

    function buildGenderChart(data) {
      const males = data.filter(d => d.gender.toLowerCase() === "male").length;
      const females = data.filter(d => d.gender.toLowerCase() === "female").length;

      new Chart(document.getElementById("genderChart"), {
        type: "pie",
        data: {
          labels: ["Male", "Female"],
          datasets: [{
            data: [males, females],
            backgroundColor: ["#36A2EB", "#FF6384"]
          }]
        }
      });
    }

    function buildTable(data) {
      const table = $("#recordsTable").DataTable();
      data.forEach(d => {
        table.row.add([d.last, d.name, d.middle, d.mother, d.birthday, d.gender, d.address, d.municipality, d.bcg, d.hepb]);
      });
      table.draw();
    }

    $(document).ready(async function () {
      const data = await fetchSheetData();
      buildGenderChart(data);
      buildTable(data);
    });
  </script>
</body>
</html>
