<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Immunization Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f9fafb; }
    h1 { text-align: center; }
    .chart-container { width: 500px; margin: 30px auto; }
    table { margin-top: 20px; }
    .filters { margin: 20px auto; text-align:center; }
    .filters select { margin: 0 10px; padding: 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Immunization Dashboard</h1>

  <div class="filters">
    <label>Municipality:
      <select id="municipalityFilter">
        <option value="">All</option>
      </select>
    </label>
    <label>BCG:
      <select id="bcgFilter">
        <option value="">All</option>
        <option value="complete">Complete</option>
        <option value="hold">Hold</option>
        <option value="pending">Pending</option>
      </select>
    </label>
    <label>HepB:
      <select id="hepbFilter">
        <option value="">All</option>
        <option value="complete">Complete</option>
        <option value="hold">Hold</option>
        <option value="pending">Pending</option>
      </select>
    </label>
  </div>

  <div class="chart-container">
    <canvas id="genderChart"></canvas>
  </div>

  <table id="recordsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Last Name</th>
        <th>First Name</th>
        <th>Middle</th>
        <th>Mother</th>
        <th>Birthday</th>
        <th>Gender</th>
        <th>Address</th>
        <th>Municipality</th>
        <th>BCG</th>
        <th>HepB</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function fetchSheetData() {
      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8qr3RNfzQobIMSn-9LMvbf4gVL-HxT0yzqp6ced96IWzRucs0rEfduPJr7YIuv3gBs5073ZQBrzTl/pub?output=csv";
      const resp = await fetch(csvUrl);
      const text = await resp.text();

      // Parse CSV safely
      const parsed = Papa.parse(text.trim(), { skipEmptyLines: true });
      const rows = parsed.data;

      rows.shift(); // remove headers
      const filtered = rows.slice(0, 40); // only A2:J41

      return filtered.map(r => ({
        last: r[0] || "",
        name: r[1] || "",
        middle: r[2] || "",
        mother: r[3] || "",
        birthday: r[4] || "",
        gender: r[5] || "",
        address: r[6] || "",
        municipality: r[7] || "",
        bcg: (r[8] || "").toLowerCase(),
        hepb: (r[9] || "").toLowerCase()
      }));
    }

    function buildGenderChart(data) {
      const males = data.filter(d => d.gender.toLowerCase() === "male").length;
      const females = data.filter(d => d.gender.toLowerCase() === "female").length;

      return new Chart(document.getElementById("genderChart"), {
        type: "pie",
        data: {
          labels: ["Male", "Female"],
          datasets: [{
            data: [males, females],
            backgroundColor: ["#36A2EB", "#FF6384"]
          }]
        }
      });
    }

    function populateFilters(data) {
      const muniSet = new Set(data.map(d => d.municipality).filter(x => x));
      muniSet.forEach(m => {
        $("#municipalityFilter").append(`<option value="${m.toLowerCase()}">${m}</option>`);
      });
    }

    function buildTable(data) {
      return $("#recordsTable").DataTable({
        data: data.map(d => [d.last, d.name, d.middle, d.mother, d.birthday, d.gender, d.address, d.municipality, d.bcg, d.hepb]),
      });
    }

    $(document).ready(async function () {
      const allData = await fetchSheetData();

      let table = buildTable(allData);
      let chart = buildGenderChart(allData);
      populateFilters(allData);

      function applyFilters() {
        const muni = $("#municipalityFilter").val();
        const bcg = $("#bcgFilter").val();
        const hepb = $("#hepbFilter").val();

        const filtered = allData.filter(d => {
          return (!muni || d.municipality.toLowerCase() === muni) &&
                 (!bcg || d.bcg.includes(bcg)) &&
                 (!hepb || d.hepb.includes(hepb));
        });

        // Refresh DataTable
        table.clear();
        table.rows.add(filtered.map(d => [d.last, d.name, d.middle, d.mother, d.birthday, d.gender, d.address, d.municipality, d.bcg, d.hepb]));
        table.draw();

        // Refresh Chart
        chart.destroy();
        chart = buildGenderChart(filtered);
      }

      $("#municipalityFilter, #bcgFilter, #hepbFilter").on("change", applyFilters);
    });
  </script>
</body>
</html>
